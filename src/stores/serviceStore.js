import { defineStore } from 'pinia';
import { ref } from 'vue';
import { googleCloudService } from '../services/googleCloudService.js';

export const useServiceStore = defineStore('services', () => {
  // Puste kategorie
  const categories = ref([
    {
      id: 'cat1',
      name: 'Strzy≈ºenie',
      description: 'Us≈Çugi strzy≈ºenia i modelowania',
      color: '#7B57FF'
    },
    {
      id: 'cat2',
      name: 'Koloryzacja',
      description: 'Farbowanie i koloryzacja w≈Ços√≥w',
      color: '#F43F5E'
    },
    {
      id: 'cat3',
      name: 'Stylizacja',
      description: 'Czesanie i stylizacja w≈Ços√≥w',
      color: '#10B981'
    },
    {
      id: 'cat4',
      name: 'Pielƒôgnacja',
      description: 'Zabiegi pielƒôgnacyjne i regeneracyjne',
      color: '#F59E0B'
    }
  ]);

  // Puste us≈Çugi - tylko kategorie zostajƒÖ
  const services = ref([]);

  const isLoading = ref(false);

  // Funkcja generujƒÖca ID
  const generateId = () => {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  };
  // Dodaj us≈Çugƒô z integracjƒÖ Google Cloud
  const addService = async (serviceData) => {
    try {
      isLoading.value = true;
      
      const newService = {
        id: generateId(),
        ...serviceData,
        active: serviceData.active !== undefined ? serviceData.active : true,
        createdAt: new Date().toISOString()
      };
      
      console.log('‚òÅÔ∏è Rozpoczynam tworzenie us≈Çugi w Cloud...');
      
      // Zapisz do Google Cloud Storage
      const createResult = await googleCloudService.createService(newService);
      
      if (createResult.success) {
        services.value.push(createResult.service);
        saveToLocalStorage();
        
        console.log('‚úÖ Us≈Çuga utworzona w Cloud Storage:', createResult.service.id);
        
        // Publikuj event
        const eventResult = await googleCloudService.publishEvent('service_created', {
          service: createResult.service,
          timestamp: new Date().toISOString()
        });
        console.log('üì® Rezultat eventu:', eventResult);
        
        return { success: true, service: createResult.service };
      } else {
        throw new Error(createResult.error || 'Failed to create service');
      }
    } catch (error) {
      console.error('B≈ÇƒÖd podczas dodawania us≈Çugi:', error);
      
      // Fallback - dodaj lokalnie
      const fallbackService = {
        ...newService,
        status: 'local_only',
        error: error.message
      };
      services.value.push(fallbackService);
      saveToLocalStorage();
      
      return { success: false, error: error.message };
    } finally {
      isLoading.value = false;
    }
  };
  // Aktualizuj us≈Çugƒô z integracjƒÖ Google Cloud
  const updateService = async (serviceData) => {
    try {
      isLoading.value = true;
      
      const index = services.value.findIndex(s => s.id === serviceData.id);
      
      if (index === -1) {
        throw new Error('Service not found');
      }
      
      const updatedService = { 
        ...serviceData,
        updatedAt: new Date().toISOString()
      };
      
      console.log('‚òÅÔ∏è Rozpoczynam aktualizacjƒô us≈Çugi w Cloud...');
      
      // Aktualizuj w Google Cloud Storage
      const updateResult = await googleCloudService.updateService(updatedService);
      
      if (updateResult.success) {
        services.value[index] = updateResult.service;
        saveToLocalStorage();
        
        console.log('‚úÖ Us≈Çuga zaktualizowana w Cloud Storage:', updateResult.service.id);
        
        // Publikuj event
        const eventResult = await googleCloudService.publishEvent('service_updated', {
          service: updateResult.service,
          timestamp: new Date().toISOString()
        });
        console.log('üì® Rezultat eventu:', eventResult);
        
        return { success: true, service: updateResult.service };
      } else {
        throw new Error(updateResult.error || 'Failed to update service');
      }
    } catch (error) {
      console.error('B≈ÇƒÖd podczas aktualizacji us≈Çugi:', error);
      
      // Fallback - aktualizuj lokalnie
      services.value[index] = updatedService;
      saveToLocalStorage();
      
      return { success: false, error: error.message };
    } finally {
      isLoading.value = false;
    }
  };
  // Usu≈Ñ us≈Çugƒô z integracjƒÖ Google Cloud
  const deleteService = async (serviceId) => {
    try {
      isLoading.value = true;
      
      const index = services.value.findIndex(s => s.id === serviceId);
      
      if (index === -1) {
        throw new Error('Service not found');
      }
      
      const serviceToDelete = services.value[index];
      
      console.log('‚òÅÔ∏è Rozpoczynam usuwanie us≈Çugi z Cloud...');
      
      // Usu≈Ñ z Google Cloud Storage
      const deleteResult = await googleCloudService.deleteService(serviceId);
      
      if (deleteResult.success) {
        services.value.splice(index, 1);
        saveToLocalStorage();
        
        console.log('‚úÖ Us≈Çuga usuniƒôta z Cloud Storage:', serviceId);
        
        // Publikuj event
        const eventResult = await googleCloudService.publishEvent('service_deleted', {
          serviceId: serviceId,
          serviceName: serviceToDelete.name,
          timestamp: new Date().toISOString()
        });
        console.log('üì® Rezultat eventu:', eventResult);
        
        return { success: true };
      } else {
        throw new Error(deleteResult.error || 'Failed to delete service');
      }
    } catch (error) {
      console.error('B≈ÇƒÖd podczas usuwania us≈Çugi:', error);
      
      // Fallback - usu≈Ñ lokalnie
      const index = services.value.findIndex(s => s.id === serviceId);
      if (index !== -1) {
        services.value.splice(index, 1);
        saveToLocalStorage();
      }
      
      return { success: false, error: error.message };
    } finally {
      isLoading.value = false;
    }
  };

  // Dodaj kategoriƒô
  const addCategory = async (categoryData) => {
    try {
      isLoading.value = true;
      
      const newCategory = {
        id: generateId(),
        ...categoryData
      };
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      categories.value.push(newCategory);
      saveToLocalStorage();
      return { success: true, category: newCategory };
    } catch (error) {
      console.error('B≈ÇƒÖd podczas dodawania kategorii:', error);
      return { success: false, error: error.message };
    } finally {
      isLoading.value = false;
    }
  };

  // Aktualizuj kategoriƒô
  const updateCategory = async (categoryData) => {
    try {
      isLoading.value = true;
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const index = categories.value.findIndex(c => c.id === categoryData.id);
      
      if (index === -1) {
        throw new Error('Category not found');
      }
      
      categories.value[index] = { ...categoryData };
      saveToLocalStorage();
      
      return { success: true, category: categories.value[index] };
    } catch (error) {
      console.error('B≈ÇƒÖd podczas aktualizacji kategorii:', error);
      return { success: false, error: error.message };
    } finally {
      isLoading.value = false;
    }
  };

  // Usu≈Ñ kategoriƒô
  const deleteCategory = async (categoryId) => {
    try {
      isLoading.value = true;
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const index = categories.value.findIndex(c => c.id === categoryId);
      
      if (index === -1) {
        throw new Error('Category not found');
      }
      
      // Sprawd≈∫ czy kategoria jest u≈ºywana przez jakƒÖ≈õ us≈Çugƒô
      const isUsed = services.value.some(s => s.categoryId === categoryId);
      
      if (isUsed) {
        throw new Error('Cannot delete category used by services');
      }
      
      categories.value.splice(index, 1);
      saveToLocalStorage();
      
      return { success: true };
    } catch (error) {
      console.error('B≈ÇƒÖd podczas usuwania kategorii:', error);
      return { success: false, error: error.message };
    } finally {
      isLoading.value = false;
    }
  };

  // Zapisz do localStorage
  const saveToLocalStorage = () => {
    try {
      localStorage.setItem('salon-services', JSON.stringify(services.value));
      localStorage.setItem('salon-categories', JSON.stringify(categories.value));
      console.log('ServiceStore - dane zapisane do localStorage');
    } catch (err) {
      console.error('ServiceStore - b≈ÇƒÖd zapisu do localStorage:', err);
    }
  };

  // Wczytaj z localStorage
  const loadFromLocalStorage = () => {
    console.log('ServiceStore - ≈Çadowanie z localStorage...');
    try {
      const savedServices = localStorage.getItem('salon-services');
      const savedCategories = localStorage.getItem('salon-categories');
      
      if (savedServices) {
        services.value = JSON.parse(savedServices);
        console.log('ServiceStore - wczytano us≈Çugi:', services.value.length);
      }
      
      if (savedCategories) {
        categories.value = JSON.parse(savedCategories);
        console.log('ServiceStore - wczytano kategorie:', categories.value.length);
      }
    } catch (err) {
      console.error('ServiceStore - b≈ÇƒÖd wczytywania z localStorage:', err);
    }
  };
  // ≈Åadowanie us≈Çug z Google Cloud Storage
  const loadFromCloudStorage = async () => {
    console.log('ServiceStore - ≈Çadowanie us≈Çug z Cloud Storage...');
    try {
      isLoading.value = true;
      
      const response = await googleCloudService.getServices();
      if (response && response.success && response.services) {
        services.value = response.services;
        console.log(`‚úÖ ServiceStore - wczytano ${response.services.length} us≈Çug z Cloud`);
        
        // Zapisz te≈º lokalnie jako backup
        saveToLocalStorage();
      } else {
        console.log('ServiceStore - brak us≈Çug w Cloud, u≈ºywam localStorage');
        loadFromLocalStorage();
      }
    } catch (error) {
      console.error('‚ùå ServiceStore - b≈ÇƒÖd ≈Çadowania z Cloud:', error);
      // Fallback do localStorage
      loadFromLocalStorage();
    } finally {
      isLoading.value = false;
    }
  };

  // Funkcja do resetowania danych
  const resetData = () => {
    categories.value = [];
    services.value = [];
    localStorage.removeItem('salon-categories');
    localStorage.removeItem('salon-services');
    console.log('üîÑ Dane us≈Çug i kategorii zosta≈Çy zresetowane');
  };
  // Wywo≈Çaj przy inicjalizacji
  loadFromCloudStorage();

  return {
    categories,
    services,
    isLoading,
    addService,
    updateService,
    deleteService,
    addCategory,
    updateCategory,
    deleteCategory,
    resetData,
    saveToLocalStorage,
    loadFromLocalStorage,
    loadFromCloudStorage
  };
});